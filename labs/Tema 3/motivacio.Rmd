---
title: "Tema 3 - Exemple de motivació"
subtitle: "Modelització de la precipitació mensual a Barcelona"
output: html_notebook
---

En aquest exemple tractaré de motivar la teoria i les eines que desenvoluparem en el Tema 3.

Suposem per un moment que sóm assessors del servei de Parcs i Jardins de Barcelona, que necessita dimensionar els dipòsits d'aigua de rec de la ciutat.

El volum d'aquests dipòsits és una funció del volum de precipitació mensual, i l'enginyer en cap del projecte vol que estudiem l'històric de precipitacions mensuals de la ciutat per tal de:

1. Assegurar-se que la capacitat dels dipòsits és suficient per cobrir les precipitacions del 90% dels mesos

2. Crear un model per simular volum de precipitacions mensuals i estudiar el comportament del sistema de dipòsits per simulació

En tant que estadístics, sabem que el primer que necessitarem son les dades.

## Històric de precipitacions des del 1786

L'Ajuntament de Barcelona [publica les dades de precipitació a la ciutat des del 1786 (!)](https://opendata-ajuntament.barcelona.cat/data/ca/dataset/precipitacio-hist-bcn/resource/6f1fb778-0767-478b-b332-c64a833d26d2). Descarreguem-les i carreguem-les en un dataframe:

```{r}
# Necessitarem aquests paquets més endavant
install.packages("EnvStats")
install.packages("reshape")

library(reshape)
library(EnvStats)

data <- read.csv('data/precipitacionsbarcelonadesde1786.csv')

# convertir les dades a una sèrie
monthly_data = melt(data, 'Any')

summary(monthly_data$value)
boxplot(monthly_data$value)
hist(monthly_data$value, breaks=25, main = "Histograma de precipitacions mensuals des del 1786")
```

El 3er-quartil està al voltant de 70mm, però fixeu-vos la quantitat de valors per sobre de 150mm que tenim. Això i la pinta de l'histograma ens fa pensar que de tant en tant s'observen valors de precipitació "extrems", de fins a 365mm, quan la mitja de precipitació és de tot just 50mm!

## Eines del tema 2: moments mostral i estadístics d'ordre

Al Tema 2 vem veure com caracteritzar la mitja i la variança d'una població
a través d'una mostra. Abans de continuar ens ha de quedar clar quina és la població i quina és la mostra en el nostre estudi:

* Població: Les precipitacions mensuals hagudes i per haver
* Mostra: Les 2808 observacions de precipitació mensual del 1786 al 2019

Com recordareu, l'objectiu de l'inferència estadística és caracteritzar atributs de la població a partir de només la mostra.

Per exemple, [a classe vam veure que](https://atibaup.github.io/ModInfer_2020/slides/0_Intro/0_2_Intro_stats.html#36) 
si (i) la mostra és iid, (ii) la variança i mitja de la població existeixen, i (iii) el tamany de la mostra $N$ és prou gran, 

$$\bar{X} \pm 2 \sqrt{\frac{S_X^2}{N}}$$
és un **interval de confiança aproximat** de nivell 95% per la mitja de la població $\mu = E(X)$. Aplicat al nostre conjunt de dades, obtenim:

```{r}
N = nrow(monthly_data)
X_bar = mean(monthly_data$value)
S_X = sd(monthly_data$value)
c(X_bar - 2*S_X/sqrt(N), X_bar + 2*S_X/sqrt(N))
```

Recordeu que això s'ha d'interpretar com segueix: Si agaféssim més mostres de la població (en un futur, o si puguéssim viatjar en el temps en el passat), *si les hipòtesis de partida (i)-(iii)* són correctes, aleshores 95% de les vegades els intervals calculats d'aquesta manera contindrien el valor real de $\mu$. Ja veieu que s'ha d'anar amb compte a l'hora d'interpretar els resultats en estadística.... 

Malgrat els nostres esforços, en aquest cas la caracterització de la mitja no ens aporta massa informació respecte a les preguntes 1 i 2 que ens ocupen. Si de cas, per tal de respondre a la pregunta (1) (*Assegurar-se que la capacitat dels dipòsits és suficient per cobrir les precipitacions del 90% dels mesos*) potser ens interessaria més mirar al moment d'ordre del percentil 90 de la mostra:

```{r}
quantile(monthly_data$value, probs = seq(0, 1, by= 0.1))
```
El 90% de mesos a la nostra mostra té una precipitació inferior o igual a 106.7mm. Podem amb això respondre a la pregunta (1)?

Com [vam veure a classe](https://atibaup.github.io/ModInfer_2020/slides/0_Intro/0_2_Intro_stats.html#47), caracteritzar l'incertesa de l'estadístic d'ordre *percentil-90* és impossible
sense recorrer a una hipòtesi sobre la llei de probabilitat que caracteritza la població. Per tant ens és
difícil de dir si aquest valor de 106.7mm és una aberració de la mostra que hem pres o si, al contrari, és una bona estimació del percentil 90 de la població, i com a tal, ens pot servir per dimensionar la capacitat dels dipòsits municipals.

Tot i així, encara que volguéssim fer un acte de fe i prendre els 106.7mm com al vertader percentil 90, les eines que hem vist fins ara al Tema 2 no ens servirien per respondre a la pregunta restant:

2. Crear un model per simular volum de precipitacions mensuals i estudiar el comportament del sistema de dipòsits per simulació

Per continuar, ens faran falta eines més sofisticades. En concret, ens fara falta **ajustar lleis o distribucions
de probabilitat** al conjunt de dades observat (i.e. la mostra).

## Ajust de lleis/distribucions de probabilitat

Si tinguéssim una manera de trobar una funció de distribució de probabilitat $f_X(x)$ que fos "bona" per les nostres dades, aleshores podriem respondre a les preguntes fàcilment:

1. *Assegurar-se que la capacitat dels dipòsits és suficient per cobrir les precipitacions del 90% dels mesos*: Calculariem el percentil 90 en base a $f_X(x)$, és a dir, trobar $\alpha$ tal que $P(X \leq \alpha) = \int_{-\infty}^{\alpha} f_X(x)dx = 0.9$.

2. *Crear un model per simular volum de precipitacions mensuals i estudiar el comportament del sistema de dipòsits per simulació*: Generariem mostres a partir de $f_X$, per exemple fent servir el [Teorema de la Transformació Integral](https://atibaup.github.io/ModInfer_2020/slides/0_Intro/0_1_Repas_probabilitat.html#51).

Per tant, tenir accés a $f_X(x)$ ens solucionaria tots els problemes. La questió és, podem fer alguna cosa per "estimar" $f_X(x)$ a partir de la mostra?

### Escollim una família de distribucions

El primer pas cap a l'ajust d'una distribució a les dades és el d'escollir una família de distribucions. Per exemple,
podriem escollir la família Gaussiana $X \sim \mathcal{N}(\mu, \sigma)$ amb f.d.p $f_X(x; \mu, \sigma)$ (fem explícita la dependència amb els paràmetres $\mu$, $\sigma$) i buscar els paràmetres
que millor representen les dades. Per exemple, podriem buscar $\mu$ i $\sigma$ tals que $f_X$ s'"assembla"
més a l'histograma de les dades:

```{r}
x = seq(round(min(monthly_data$value)), round(max(monthly_data$value)), 1)
hist(monthly_data$value, 50, freq = F)
lines(x, dnorm(x, 50, 10), col='blue')
lines(x, dnorm(x, 50, 50), col='red')
lines(x, dnorm(x, 50, 100), col='green')
legend(200, 0.015, c("mu=50, sigma=10", "mu=50, sigma=50", "mu=50, sigma=100"), col=c('blue', 'red', 'green'), lty=1)
```
Visualment, sembla que entre aquests 3, el que més s'assembla a l'histograma és $\mu=50, \sigma=50$. Però i
si provéssim altres combinacions? Segurament en trobariem alguna que s'hi assemblaria més... obviament
és un procés una mica tediós.

Per altra banda, l'histograma de precipitacions no té una pinta massa Gaussiana. Més aviat ens recorda
al perfil d'una Gamma o d'una exponencial. Provem d'ajustar els dos paràmetres ("shape" i "scale") d'una Gamma fent servir el mateix mètode "a ojo":

```{r}
x = seq(round(min(monthly_data$value)), round(max(monthly_data$value)), 1)
hist(monthly_data$value, 50, freq = F)
lines(x, dgamma(x, 1, scale=40), col='blue')
lines(x, dgamma(x, 10, scale=20), col='red')
lines(x, dgamma(x, 20, scale=10), col='green')
legend(200, 0.015, c("shape=1, scale=40", "shape=10, scale=20", "shape=20, scale=10"), col=c('blue', 'red', 'green'), lty=1)
```
Com a mínim ara hem trobat un parell de valors (shape=1, scale=40) eels que sembla que la f.d.p. de la gamma s'assembla més a les nostres dades... però ja veieu que la nostra metodologia no és massa pràctica.


### Metòde del màxim de versemblança (Maximum Likelihood)

La primera manera que veurem 


```{r}
library(EnvStats)

gamma_estimates = egamma(data$total, ci=T)

x = seq(round(min(data$total)), round(max(data$total)), 1)
fitted_distrib = dgamma(x, gamma_estimates$parameters["shape"], scale=gamma_estimates$parameters["scale"])

hist(data$total, 50, freq = F)
lines(x, fitted_distrib, col='red')
lines(x, dpois(x,mean(data$total)), col='green')
lines(x, dnorm(x,mean(data$total), sd(data$total)), col='blue')
lines(x, dlnorm(x, mean(log(data$total)), sd(log(data$total))), col='black')
```
